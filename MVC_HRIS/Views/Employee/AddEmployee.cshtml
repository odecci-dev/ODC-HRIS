@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor Accessor;
@{
    ViewData["Title"] = "Add New Employee";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string message = "";
    if (ViewData["Message"] != null)
    {
        message = ViewData["Message"].ToString();
    }
}

<div id="emp-main-container" >
    <div class="title-main-container-2">
          <h4 style="font-size: 26px;" class="text-left"> <a href="@Url.Action("Index", "Employee")"> <i class="fa-solid fa-arrow-left" style="margin: 25px;font-size: 25px;"></i></a> <i class="fa-solid fa-users" style="margin: 10px;"></i> @ViewData["Title"].ToString()</h4>
    </div>
    <div class="bordered">
        <div id="grid-main-container" >
             <div class="title-main-container-2">
                <div class="content-container" style="flex-direction: column; border-bottom: 1px solid var(--secondary-dark);">
                    <span class="text-left">Employee Information</span>
                </div>
            </div>
            <div class="top-main-container">
        <div class="content-filter-nm">
            <div class="sub-content">
                  <form action="" class="mod-form" id="employeeForm">
            <div class="body-container">
                <div class="emp_title">
                    <div class="mod-form-row2">
                        <div class="input-container-whole">

                            <div class="input-container-whole1">

                                <div class="upload-image-preview1" id="upload-image-preview" style="background-color: gainsboro;">
                                    <img width="100%"
                                         src="/img//emptypic.png"
                                         alt="" />
                                </div>
                                <div style="margin: 10px 0px 25px 0px;display: flex;">
                                    <label for="img">Upload Image</label>
                                    <input type="file"
                                           value=""
                                           id="img"
                                           class="mod-input img-choose"
                                           name="uploadimg" accept="image" />
                                </div>

                            </div>

                        </div>

                    </div>



                </div>

                <div class="boder-line-none">
                    <div class="mod-form-row">
                        <div class="input-container-whole">
                            <label class="label-color" for="empid">Employee ID #</label>
                            <input type="text" value="" id="empid" class="mod-input" disabled />
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="department">Department </label>
                            <select id="department" class="mod-input" style="width:100%" required>
                                <option value="" disabled selected>Select Department</option>
                            </select>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="position">Postion  </label>
                                            <select id="position" class="mod-input" style="width:100%" required>
                                <option value="" disabled selected>Select Position</option>
                            </select>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="emptype">Employee Type  </label>
                                            <select id="emptype" class="mod-input" style="width:100%" required>
                                <option value="" disabled selected>Select Employee Type</option>
                            </select>
                        </div>
                    </div>
                    <div class="mod-form-row">
                        <div class="input-container-whole">
                            <label class="label-color" for="lname">Last Name</label>
                            <input type="text" value="" id="lname" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="fname">First Name</label>
                            <input type="text" value="" id="fname" class="mod-input"required />
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="mname">Middle Name</label>
                            <input type="text" value="" id="mname" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="suffix">Suffix</label>
                            <input type="text" value="" id="suffix" class="mod-input" />
                        </div>
                    </div>

                    <div class="mod-form-row">
                        <div class="input-container-whole">
                            <label class="label-color" for="email">Email</label>
                            <input type="text" value="" id="email" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="cno">Contact #</label>
                            <input type="text" value="" id="cno" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="gender">Gender</label>
                            <select id="gender" class="mod-input"required>
                                <option value="" disabled selected>Select your option</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="datehired">Date Hired</label>
                            <input type="date" id="datehired" value="@DateTime.Now.ToString("yyyy-MM-dd")" class="mod-input" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="body-container">
                <div class="emp_title">
                    <p>Payroll Information</p>

                </div>

                <div class="boder-line">
                </div>

            </div>
            <div class="body-container">
                <div class="emp_title">
                    <div class="input-container-whole">
                        <label class="label-color" for="payrolltype">Payroll Type  </label>
                        <select id="payrolltype" class="mod-input" style="width:100%" required>
                            <option value="" disabled selected>Select Payroll Type</option>
                        </select>
                    </div>
                </div>

                <div class="boder-line-none">
                    <div class="mod-form-row">
                        <div class="input-container-whole">
                            <label class="label-color" for="salarytype">Salary Type </label>
                                            <select id="salarytype" class="mod-input" style="width:100%" required>
                                <option value="" disabled selected>Select Salary Type</option>
                            </select>
                        </div>
                        <div class="input-container-whole">

                            <label class="label-color" for="rate">Rate</label>
                            <input type="number" value="" id="rate" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="daysinmonth">Days in Month</label>
                            <input type="number" value="" id="daysinmonth" class="mod-input"required />
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="status">Status </label>
                                            <select id="status" class="mod-input" style="width:100%" required>
                                <option value="" disabled selected>Select Status</option>
                                <option value="1">ACTIVE</option>
                                <option value="0">INACTIVE</option>
                            </select>
                        </div>

                    </div>

                </div>
            </div>
            <div class="body-container">
                <div class="emp_title">
                    <p>Address Information</p>

                </div>

                <div class="boder-line">
                </div>

            </div>
            <div class="body-container">
                <div class="emp_title">
                    <div class="input-container-whole">
                        <label class="label-color" for="cob">Country of Birth  </label>
                        <input type="text" value="" id="cob" class="mod-input" required/>
                    </div>
                </div>

                <div class="boder-line-none">
                    <div class="mod-form-row">
                        <div class="input-container-whole">
                            <label class="label-color" for="region">Region</label>
                            <input type="text" value="" id="region" class="mod-input"required />
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="province">Province</label>
                            <input type="text" value="" id="province" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="municipality">Municipality </label>
                            <input type="text" value="" id="municipality" class="mod-input" required/>
                        </div>
                        <div class="input-container-whole">
                            <label class="label-color" for="barangay">Barangay </label>
                            <input type="text" value="" id="barangay" class="mod-input"required  />
                        </div>
                    </div>

                </div>
            </div>

            <div class="tbl-btn-container">
            <div class="btn-footer-container" style="margin-right:45px; gap:20px">
                    <button type="button" class="btn btn-danger" id="cancel-button" onclick="window.location.href='@Url.Action("Index", "Employee")'">
                    <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button class="btn btn-primary" id="add-info" title="Add New Employee">
                <i class="fa-solid fa-floppy-disk"></i> Save Information</button>
            </div>
        </div>
        </form>
               
            </div>
        </div>
        </div>
       </div>
  </div>



</div>
</div>
    
@section Scripts {
    <script>
        var img_edit = "";
        $(document).ready(function () {
            fetchpositionselect();
            fetchdepartmentselect();
            fetchusertypeselect();
            fetchpayrolltypeselect();
            getempdetails();
            fetchsalarytypeselect();
            fetchstatusselect();
            $("input[name=uploadimg]").change(function () {

                if (this.files && this.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var img = $('<img>').attr('src', e.target.result);
                        img.attr('height', '100%');
                        img.attr('width', '100%');
                        $('.upload-image-preview1').html(img);
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        });
        $('#employeeForm').submit(function (e) {
            e.preventDefault();
            filename = $("#img").val().replace(/.*(\/|\\)/, '');
            console.log(filename);
            if (filename == "" || filename == null) {
                filename = img_edit;
            }
            var Id = localStorage.getItem('id');
            var department = document.getElementById('department').value;
            var position = document.getElementById('position').value;
            var emptype = document.getElementById('emptype').value;
            var lname = document.getElementById('lname').value;
            var fname = document.getElementById('fname').value;
            var mname = document.getElementById('mname').value;
            var suffix = document.getElementById('suffix').value;
            var email = document.getElementById('email').value;
            var gender = document.getElementById('gender').value;
            var datehired = document.getElementById('datehired').value;
            var payrolltype =  document.getElementById('payrolltype').value; 
            var salarytype =  document.getElementById('salarytype').value
            var rate = document.getElementById('rate').value;
            var status = document.getElementById('status').value;
            var address = document.getElementById('cob').value + ", " + document.getElementById('region').value + ", "
                + document.getElementById('province').value + ", "
                + document.getElementById('municipality').value
                + ", " + document.getElementById('barangay').value;
            var cno = document.getElementById('cno').value;
            var createdby = @Accessor.HttpContext.Session.GetString("Id");
            // Gather other fields similarly
            console.log(position);
            // Prepare data object to send via AJAX
            var data = {
                Department: department,
                FilePath: filename,
                Id: Id,
                UserType: emptype,
                Cno: cno,
                Lname: lname,
                Fname: fname,
                Position: position,
                Mname: mname,
                Suffix: suffix,
                Email: email,
                Gender: gender,
                DateStarted: datehired,
                SalaryType: salarytype,
                Status: status,
                Address: address,
                PayrollType: payrolltype,
                CreatedBy: createdby.toString()
                // Add other fields as needed
            };
            console.log(data);
            var input = document.getElementById('img');
            let formData = new FormData();
            var fileUpload = $("#img").get(0);
            var files = fileUpload.files;
            var m_files = input.files;
            for (var i = 0; i != m_files.length; i++) {
                formData.append("file", m_files[i]); //loop through all files and append
            }
            formData.append('file', files[0]);
      
            message = 'Are you sure you want to Add new Privilege';

         

                
            $.ajax({
                url: '/Employee/SaveEmployee',
                data: {
                    data: data,
                },
                type: "POST",
                datatype: "json"
            }).done(function (data) {
                console.log(data);
                if (data.status == '200') {
                    $.ajax({
                        url: '/Employee/UploadFile',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,

                        success: function (result) {
                            console.log(result);
                        }
                    });
                    notifyMsg('Success!', 'Successfully Saved', 'green', 'fas fa-check');
                    // window.location.href = '@Url.Action("Index", "Employee")';
                }
                else {
                    notifyMsg('Warning!', data.status, 'red', 'fas fa-exclamation-triangle');
                }

            });
       

        });
    
        function getempdetails() {
            const data = { Id: localStorage.getItem('id') };
            $.ajax({
                url: '/Employee/GetEmployeeDetails',
                data: {
                    data: data,
                },
                type: "POST",
                beforeSend: function () {
                    showloadingoverlay();
                },
                datatype: "json",
                success: function (response) {
                    console.log(response);
                    var array = response[0].address.split(',');
                    console.log(response);
                    if (array.length > 1) {
                        $('#cob').val(array[0]);
                        $('#region').val(array[1]);
                        $('#province').val(array[2]);
                        $('#municipality').val(array[3]);
                        $('#barangay').val(array[4]);
                    }
                    else {
                        $('#cob').val(array[0]);
                    }
                    let date = new Date(response[0].dateStarted);
                    let formattedDate = date.toISOString().split('T')[0];
                    $('#empid').val(response[0].employeeId);
                    $('#position').val(response[0].position);
                    $('#department').val(response[0].department);
                    $('#suffix').val(response[0].suffix);
                    $('#emptype').val(response[0].userType);
                    $('#lname').val(response[0].lname);
                    $('#fname').val(response[0].fname);
                    $('#mname').val(response[0].mname);
                    $('#email').val(response[0].email);
                    $('#cno').val(response[0].cno);
                    $('#gender').val(response[0].gender);
                    $('#datehired').val(formattedDate);
                    $('#payrolltype').val(response[0].payrollType);
                    $('#salarytype').val(response[0].salaryType);
                    $('#status').val(response[0].status);
                    img_edit = response[0].filePath;
                    console.log(img_edit);
                    if (img_edit != "/img/OPTION.webp") {
                        var img = $('<img>').attr('src', img_edit);
                        img.attr('height', '100%');
                        img.attr('width', '100%');
                        $('.upload-image-preview1').html(img);
                    }
                    else {
                        var img = $('<img>').attr('src', img_edit);
                        img.attr('height', '100%');
                        img.attr('width', '100%');
                        $('.upload-image-preview1').html(img);

                    }

                },
                error: function (jqXHR, textStatus, errorThrown) {
                   
                    console.error(textStatus, errorThrown);
                },
                complete: function () {

                    hideloadingoverlay();
                }
            });
        }

    </script>
}